name: Build Docker Images
run-name: Build Images [${{ github.event.inputs.mode || 'single' }}:${{ github.event.inputs.build_target || 'n/a' }}${{ github.event.inputs.stop_after && format(':{0}', github.event.inputs.stop_after) || '' }}]

on:
    workflow_dispatch:
        inputs:
            mode:
                default: "single"
                description: "single = one image; chain = run ordered pipeline starting at start_at"
                options: [ "single", "chain" ]
                required: true
                type: choice
            build_target:
                default: "debian"
                description: "Image name (debian, postgres, nginx). Context-aware based on mode."
                options: [ "debian", "action-split", "nginx", "postgres", "curl", "php-fpm-base-master", "php-fpm-master", "php-fpm-testing-master", "php-fpm-socket-master", "php-fpm-base", "php-fpm", "php-fpm-testing", "php-fpm-socket", ]
                required: true
                type: choice
            no_cache:
                default: "false"
                description: "Build with --no-cache"
                options: [ "true", "false" ]
                required: false
                type: choice
            stop_after:
                default: ""
                description: "Stop building after this image (chain mode only)"
                options: [ "", "debian", "action-split", "nginx", "postgres", "curl", "php-fpm-base-master", "php-fpm-master", "php-fpm-testing-master", "php-fpm-socket-master", "php-fpm-base", "php-fpm", "php-fpm-testing", "php-fpm-socket", ]
                required: false
                type: choice

permissions:
    contents: read
    packages: write

env:
    OWNER: ghcr.io/valksor
    PHP_OWNER: ghcr.io/valksor/php

jobs:
    build:
        runs-on: self-arm
        steps:

            -   name: checkout
                uses: actions/checkout@v6

            -   name: Login GHCR
                uses: docker/login-action@v3
                with:
                    registry: ghcr.io
                    username: ${{ github.repository_owner }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Login DockerHub
                uses: docker/login-action@v3
                with:
                    registry: docker.io
                    username: ${{ secrets.DH_USERNAME }}
                    password: ${{ secrets.DH_TOKEN }}

            -   name: Plan run list
                id: plan
                shell: bash
                run: |
                    set -euo pipefail
                    ORDER=(debian action-split nginx postgres curl php-fpm-base-master php-fpm-master php-fpm-testing-master php-fpm-socket-master php-fpm-base php-fpm php-fpm-testing php-fpm-socket)

                    MODE="${{ github.event.inputs.mode }}"
                    BUILD_TARGET="${{ github.event.inputs.build_target }}"
                    STOP_AFTER="${{ github.event.inputs.stop_after }}"

                    RUN_LIST=()

                    if [[ "$MODE" == "single" ]]; then
                        # single mode: build exactly one specific image
                        RUN_LIST=("$BUILD_TARGET")
                    else
                        # chain mode: build from target to end of pipeline (or stop_after if specified)
                        start_target="$BUILD_TARGET"

                        RUN=false
                        STOPPED=false
                        for s in "${ORDER[@]}"; do
                            if [[ "$s" == "$start_target" ]]; then RUN=true; fi
                            if $RUN && ! $STOPPED; then
                                RUN_LIST+=("$s")
                                if [[ -n "$STOP_AFTER" && "$s" == "$STOP_AFTER" ]]; then
                                    STOPPED=true
                                fi
                            fi
                        done
                    fi

                    PADDED=" ${RUN_LIST[*]} "
                    echo "run_list=$PADDED" >> "$GITHUB_OUTPUT"

                    echo "MODE=$MODE"
                    echo "BUILD_TARGET=$BUILD_TARGET"
                    echo "STOP_AFTER=$STOP_AFTER"
                    echo "RUN_LIST=${RUN_LIST[*]}"

            # -------------------------
            # Stage: Base
            # -------------------------

            -   name: build debian
                if: contains(steps.plan.outputs.run_list, ' debian ')
                uses: ./.github/actions/build-simple
                with:
                    dockerfile: debian/Dockerfile
                    tags: |
                        ${{ env.OWNER }}/debian:latest
                    build-args: |
                        CACHE_BUSTER=${{ github.run_id }}
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build action split
                if: contains(steps.plan.outputs.run_list, ' action-split ')
                uses: ./.github/actions/build-simple
                with:
                    dockerfile: action/split/Dockerfile
                    tags: |
                        ${{ env.OWNER }}/action/split:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build nginx
                if: contains(steps.plan.outputs.run_list, ' nginx ')
                uses: ./.github/actions/build-simple
                with:
                    dockerfile: nginx/Dockerfile
                    tags: |
                        ${{ env.OWNER }}/nginx:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build postgres (17..18)
                if: contains(steps.plan.outputs.run_list, ' postgres ')
                uses: ./.github/actions/build-postgres
                with:
                    versions: "17 18"
                    dockerfile: postgres/Dockerfile
                    image: ${{ env.OWNER }}/postgres
                    no_cache: ${{ github.event.inputs.no_cache }}

            # -------------------------
            # Stage: Curl
            # -------------------------

            -   name: build curl
                if: contains(steps.plan.outputs.run_list, ' curl ')
                uses: ./.github/actions/build-curl
                with:
                    dockerfile: curl/Dockerfile
                    tags: |
                        ${{ env.OWNER }}/curl:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            # -------------------------
            # Stage: PHP master chain
            # -------------------------

            -   name: build php-fpm-base-master
                if: contains(steps.plan.outputs.run_list, ' php-fpm-base-master ')
                uses: ./.github/actions/build-php-base
                with:
                    dockerfile: php/base/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm-base:master
                    no_cache: ${{ github.event.inputs.no_cache }}
                    php_branch: master
                    php_version: "8.6.0-dev"

            -   name: build php-fpm-master
                if: contains(steps.plan.outputs.run_list, ' php-fpm-master ')
                uses: ./.github/actions/build-php
                with:
                    dockerfile: php/fpm/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm:master
                    no_cache: ${{ github.event.inputs.no_cache }}
                    php_branch: master
                    php_version: "8.6.0-dev"

            -   name: build php-fpm-testing-master
                if: contains(steps.plan.outputs.run_list, ' php-fpm-testing-master ')
                uses: ./.github/actions/build-php-testing
                with:
                    dockerfile: php/testing/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm-testing:master
                    no_cache: ${{ github.event.inputs.no_cache }}
                    php_branch: master
                    php_version: "8.6.0-dev"

            -   name: build php-fpm-socket-master
                if: contains(steps.plan.outputs.run_list, ' php-fpm-socket-master ')
                uses: ./.github/actions/build-php-sockets
                with:
                    dockerfile1: php/socket/Dockerfile
                    tags1: |
                        ${{ env.PHP_OWNER }}/fpm-socket:master
                    dockerfile2: php/testing-socket/Dockerfile
                    tags2: |
                        ${{ env.PHP_OWNER }}/fpm-testing-socket:master
                    no_cache: ${{ github.event.inputs.no_cache }}
                    base_tag: :master

            # -------------------------
            # Stage: PHP chain
            # -------------------------

            -   name: build php-fpm-base
                if: contains(steps.plan.outputs.run_list, ' php-fpm-base ')
                uses: ./.github/actions/build-php-base
                with:
                    dockerfile: php/base/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm-base:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build php-fpm
                if: contains(steps.plan.outputs.run_list, ' php-fpm ')
                uses: ./.github/actions/build-php
                with:
                    dockerfile: php/fpm/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build php-fpm-testing
                if: contains(steps.plan.outputs.run_list, ' php-fpm-testing ')
                uses: ./.github/actions/build-php-testing
                with:
                    dockerfile: php/testing/Dockerfile
                    tags: |
                        ${{ env.PHP_OWNER }}/fpm-testing:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

            -   name: build php-fpm-socket
                if: contains(steps.plan.outputs.run_list, ' php-fpm-socket ')
                uses: ./.github/actions/build-php-sockets
                with:
                    dockerfile1: php/socket/Dockerfile
                    tags1: |
                        ${{ env.PHP_OWNER }}/fpm-socket:latest
                    dockerfile2: php/testing-socket/Dockerfile
                    tags2: |
                        ${{ env.PHP_OWNER }}/fpm-testing-socket:latest
                    no_cache: ${{ github.event.inputs.no_cache }}

    cleanup:
        needs: build
        runs-on: self-arm
        if: always()
        steps:
            -   name: cleanup
                shell: bash
                run: |
                    ls -la ./
                    rm -rf ./* || true
                    rm -rf ./.??* || true
                    ls -la ./
                    docker builder prune -af

name: "Build PHP-FPM testing"
description: "Clone php-src, pcov, xdebug then build"
inputs:
    dockerfile:
        description: "Path to Dockerfile"
        required: true
    tags:
        description: "Tags to apply (one per line)"
        required: true
    no_cache:
        description: "Use --no-cache"
        required: false
        default: "false"
    php_branch:
        description: "PHP branch to clone (empty = default branch)"
        required: false
        default: ""
    php_version:
        description: "PHP version for build"
        required: false
        default: "8.5.0-dev"
    base_image:
        description: "Base image to pull (fpm or zts)"
        required: false
        default: "fpm"
    extra_repos:
        description: "Extra repos to clone (format: 'name1=url1 name2=url2')"
        required: false
        default: ""
runs:
    using: "composite"
    steps:
        -   uses: actions/checkout@v6

        -   uses: ./.github/actions/clone-php-repos
            with:
                php_branch: ${{ inputs.php_branch }}
                base_image: ${{ inputs.base_image }}
                include_testing: "true"
                extra_repos: ${{ inputs.extra_repos }}

        -   uses: ./.github/actions/build-simple
            with:
                dockerfile: ${{ inputs.dockerfile }}
                tags: ${{ inputs.tags }}
                no_cache: ${{ inputs.no_cache }}
                build-args: |
                    BASE_TAG=${{ inputs.php_branch == 'master' && ':master' || ':latest' }}
                    PHP_VERSION=${{ inputs.php_version }}
